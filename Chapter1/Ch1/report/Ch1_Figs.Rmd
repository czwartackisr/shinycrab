---
title: "Predicting blue crab abundance and landings from fisheries independent surveys in Charleston Harbor, South Carolina"
output:
  pdf_document: default
  word_document: default
editor_options: 
  chunk_output_type: inline
---


```{r knitr setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r setup, include=FALSE, echo=FALSE}
library(ggplot2)
library(lubridate)
library(tidyr)
library(dplyr)
library(Hmisc)
library(nlme)
library(cowplot)
library(grid)
library(gridExtra)
library(ggpmisc)
library(knitr)

theme_set(theme_classic(base_size = 12)+
            theme(panel.grid.major = element_blank(), 
                  panel.grid.minor = element_blank(),
                  panel.background = element_rect(colour = "black", size=0.5))+
            theme(text=element_text(size=12,  family="serif", colour = "black"))+
            theme(axis.text = element_text(colour = "black"))+
            theme(axis.ticks = element_line(colour = "black"))
)
update_geom_defaults("point",   list(colour = "black"))
update_geom_defaults("line",   list(colour = "black"))
theme_update(plot.title = element_text(hjust = 0.5))
```


# Abstract

Marked high fluctuations in blue crab (Callinectes sapidus) seasonal and annual abundance, and commercial landings are typical, but data from both fisheries independent and dependent surveys have shown declines in populations in recent years in South Carolina. Despite several long-term fisheries independent surveys encountering blue crab, predictive models have not recently been developed in South Carolina to quantify variation in abundance and commercial landings.  The goal of this study is to assess the current status of blue crab in SC and explore the potential for developing a more predictive understanding of commercial landings. This goal is me through the following objectives: 1) assess long-term trends in blue crab landings and fisheries-independent abundance, 2) test the applicability of a juvenile index, where juvenile abundance in one year predicts adult abundance in a following year, 3) explore predictive relationships between fisheries-independent abundance and commercial landings. Data from several long-term South Carolina Department of Natural Resources (SCDNR) fisheries independent blue crab surveys were standardized for each of 6 surveys and commercial landings data were compiled.  Long-term trends showed… Analyses testing the applicability of a juvenile index showed that the Creek Trawl survey was the only survey with significant, but weak, correlative relationships between multiple lagged population structure variables and its own annual abundance. Significant relationships were found with effort-corrected commercial landings predicted by the previous year’s abundance of males crabs. This relationship was significant for immature crabs collected in the Harbor Trawl survey, and for mature crabs collected in the Creek Trawl survey. These results suggest effective population sampling, but a potential influence on abundance of blue crab from outside factors such as fishing, habitat or environmental variables.  


```{r Data Read-In, include=FALSE, warning=FALSE, message=FALSE}

crabdata <- read.csv("ClassSizeAbunDistinct_201912.csv", stringsAsFactors = FALSE)


#Source - Eric Hiltz OFM Fisheries Statistics
#Wrangled in Excel due to confidentiality
depend <- read.csv("MonthlyDependent.csv")
```

```{r Data Wrangling, include=FALSE, warning=FALSE, message=FALSE}
B90T38 = crabdata %>% #Formerly crab1
  select(1:4, 7:16) %>%
  filter(ProjID %in% c("B90", "T38")) %>%
  rename(Total = CPUE,
         Juvenile = JuvCPUE,
         Subadult = SubadultCPUE,
         Adult = AdultCPUE,
         "Immature Female" = ImmatureFemaleCPUE,
         "Mature Female" = MatureFemaleCPUE,
         "Immature Male" = ImmatureMaleCPUE,
         "Mature Male" = MatureMaleCPUE,
         Sublegal = SublegalCPUE,
         Legal = LegalCPUE) %>%
  gather("Lifestage", "CPUE", 5:14) %>%
  mutate(Year = year(StartTime)) %>%
  mutate(Month = month(StartTime)) %>%
  select(1,2,4,3,7,8,5,6) 

T06 = crabdata %>% #Formerly crab1
  select(1:4, 7:16) %>%
  filter(ProjID %in% "T06") %>%
  rename(Total = CPUE) %>%
  select(1:5) %>%
  gather("Lifestage", "CPUE", 5) %>%
  mutate(Year = year(StartTime)) %>%
  mutate(Month = month(StartTime)) %>%
  select(1,2,4,3,7,8,5,6) 


P88 = crabdata %>% #Formerly crab1
  select(1:4, 7:16) %>%
  filter(ProjID %in% "P88") %>%
  rename(Total = CPUE,
         Sublegal = SublegalCPUE,
         Legal = LegalCPUE) %>%
  distinct(Coll, .keep_all = TRUE) %>%
  select(1:5, 13, 14) %>%
  gather("Lifestage", "CPUE", 5:7) %>%
  mutate(Year = year(StartTime)) %>%
  mutate(Month = month(StartTime)) %>%
  select(1,2,4,3,7,8,5,6) 

p88Crab = crabdata %>% #Formerly crab1
  select(1:4, 7:16) %>%
  filter(ProjID %in% "P88") 


SCECAP = crabdata %>% #Formerly crab1
  select(1:4, 7:16) %>%
  filter(ProjID %in% c("E98", "E99")) %>%
  rename(Total = CPUE,
         Sublegal = SublegalCPUE,
         Legal = LegalCPUE,
         Juvenile = JuvCPUE,
         Subadult = SubadultCPUE,
         Adult = AdultCPUE) %>%
  select(1:8, 13, 14) %>%
  gather("Lifestage", "CPUE", 5:10) %>%
  mutate(Year = year(StartTime)) %>%
  mutate(Month = month(StartTime)) %>%
  select(1,2,4,3,7,8,5,6) 

crab1 = rbind(B90T38, P88) %>%
  rbind(., T06) %>%
  rbind(., SCECAP)



#Source - Eric Hiltz OFM Fisheries Statistics
#Wrangled in Excel due to confidentiality
depend <- read.csv("MonthlyDependent.csv")


#Joining Independent and Dependent 
crab3 = full_join(crab1, depend,
                  by = c("ProjID", "StationCode", "Year", 
                         "Month", "Lifestage", "CPUE")) %>%
  mutate(ProjID = as.factor(ProjID)) %>%
  mutate(Coll = as.factor(Coll)) %>%
  mutate(StationCode = as.factor(StationCode)) %>%
  mutate(StartTime = ymd(StartTime)) %>%
  mutate(Year = as.numeric(Year)) %>%
  mutate(Month = as.factor(Month)) %>%
  mutate(Lifestage = as.factor(Lifestage)) %>%
  group_by(ProjID, StationCode, Lifestage, Month) %>%
  mutate(Means = mean(CPUE, na.rm=TRUE),
         SDs = sd(CPUE, na.rm=TRUE),
         Zs = (CPUE-Means)/ifelse(SDs>0,SDs, 0.00000001)) %>%
  ungroup() 

#### IS.FINITE NEEDS TO GO HERE FOR mATURE fEMALE STAT_SUMMS AND GEOM_HLINES

crab = crab3 %>%
  mutate(ProjID = recode(ProjID, 'B90' = "Harbor Trawl",
                         'T38' = "Creek Trawl",
                         'T06' = "Trammel Net",
                         'P88' = "Ashley Potting",
                         'E98' = "SCECAP Creek Trawl",
                         'E99' = "SCECAP Harbor Trawl"))


```
\newpage
## Objective 1
Assess long-term trends in blue crab landings and fisheries-independent abundance
\newline

```{r Figure 1, echo=FALSE, message=FALSE, warning=FALSE,dpi=600, fig.cap="(A) Total annual blue crab Landings (mean ± standard error), and (B) effort corrected mean annual landings (mean ± standard error) for all reporting areas within the Charleston Harbor watershed (Ashley River, Wando River, Cooper River and Charleston Harbor).  Dark line is loess smoothing trendline.  Broken line is survey mean.", fig.width=10,fig.height=11}
LandingsCPUEFormTotal = subset(crab,
                           ProjID == "LandingsCPUEMean")

formula1 <- lm(LandingsCPUEFormTotal$CPUE ~ LandingsCPUEFormTotal$Year)

LandingsCrab = crab %>%
  filter(ProjID == c("LandingsSum", "LandingsCPUEMean")) %>%
  group_by(ProjID) %>%
  mutate(Means = mean(CPUE, na.rm=TRUE),
         SDs = sd(CPUE, na.rm=TRUE),
         Zs = (CPUE-Means)/ifelse(SDs>0,SDs, 0.00000001)) %>%
  ungroup() 


LandingsCPUE = ggplot(aes(Year, CPUE), data = subset(LandingsCrab,
                                                     ProjID == "LandingsCPUEMean")) +
  #ggtitle("Commercial Landings CPUE\nCharleston Harbor (Combined Watersheds)") +
  geom_hline(aes(yintercept=mean(CPUE)), linetype="dashed") +
  stat_summary(fun.data = "mean_se", size = .7) +
  #stat_poly_eq(aes(label = ..eq.label..), formula = formula1, parse = TRUE) +
  geom_smooth(method = 'loess', se=FALSE, color="black") +
  labs(y=expression(Blue~crab~~per~pot~fished^{-1})) +
  expand_limits(x=c(1980, 2022)) 





LandingsFormTotal = subset(crab,
                      ProjID == "LandingsSum")
formula2 <- lm(LandingsFormTotal$CPUE ~ LandingsFormTotal$Year)
Landings = ggplot(aes(Year, CPUE), data = subset(LandingsCrab,
                                                 ProjID == "LandingsSum")) +
  ggtitle("Commercial Landings CPUE\nCharleston Harbor (Combined Watersheds))") +
  geom_hline(aes(yintercept=mean(CPUE)), linetype="dashed") +
  stat_summary(fun.data = "mean_se", size = .7) +
  #stat_poly_eq(aes(label = ..eq.label..), formula = formula2, parse = TRUE) +
  geom_smooth(method = 'loess', se=FALSE, color="black") +
  labs(y=expression(Blue~crab~lbs.~per~year^{-1}), x=expression(" ")) +
  expand_limits(x=c(1980, 2022)) 


LandingsTimeSeries <- plot_grid(Landings, LandingsCPUE, ncol = 1, align = 'hv', labels = c("A", "B"))

LandingsTimeSeries

```

```{r B90 Size Wrangle, include=FALSE, warning=FALSE, message=FALSE}
TotalCrab = crab %>%
  filter(Lifestage == "Total")
TotalCrab$ProjID <- factor(TotalCrab$ProjID, levels = c("Harbor Trawl",
                                                        "SCECAP Harbor Trawl",
                                                        "Creek Trawl",
                                                        "SCECAP Creek Trawl",
                                                        "Trammel Net",
                                                        "Ashley Potting"))

B90FormTotal = subset(TotalCrab,
                     ProjID == "Harbor Trawl")
formula3 <- lm(B90FormTotal$CPUE ~ B90FormTotal$Year)
B90TotalCPUE = ggplot(aes(Year, CPUE), data = subset(TotalCrab,
                                                     ProjID == "Harbor Trawl")) +
  ggtitle(" ") +
  #ggtitle("Harbor Trawl") + 
  stat_summary(fun.data = "mean_se", size = .7) +
  #stat_poly_eq(aes(label = ..eq.label..), formula = formula3, parse = TRUE) +
  geom_smooth(method = 'loess', se=FALSE, color="black") +
  geom_hline(aes(yintercept=mean(Means)), linetype="dashed") +
  labs(y=expression(" "), x=expression(" ")) +
  #labs(y=expression(Blue~crab~per~tow^{-1})) +
  expand_limits(x=2020)
#B90TotalCPUE

T38FormTotal = subset(TotalCrab,
                     ProjID == "Creek Trawl")
formula4 <- lm(T38FormTotal$CPUE ~ T38FormTotal$Year)
T38TotalCPUE = ggplot(aes(Year, CPUE), data = subset(TotalCrab,
                                                     ProjID == "Creek Trawl")) +
  ggtitle(" ") +
    #ggtitle("Creek Trawl") +
  stat_summary(fun.data = "mean_se", size = .7) +
  #stat_poly_eq(aes(label = ..eq.label..), formula = formula4, parse = TRUE, label.x = "right") +
  geom_smooth(method = 'loess', se=FALSE, color="black") +
  geom_hline(aes(yintercept=mean(Means)), linetype="dashed") +
  labs(y=expression(" "), x=expression(" ")) +
  #labs(y=expression(Blue~crab~per~tow^{-1})) +
  expand_limits(x=2020)
#T38TotalCPUE

T06FormTotal = subset(TotalCrab,
                     ProjID == "Trammel Net")
formula5 <- lm(T06FormTotal$CPUE ~ T06FormTotal$Year)
T06TotalCPUE = ggplot(aes(Year, CPUE), data = subset(TotalCrab,
                                                     ProjID == "Trammel Net")) +
  ggtitle(" ") +
  #ggtitle("Trammel Net") +
  stat_summary(fun.data = "mean_se", size = .7) +
  #stat_poly_eq(aes(label = ..eq.label..), formula = formula5, parse = TRUE) +
  geom_smooth(method = 'loess', se=FALSE, color="black") +
  labs(y=expression(" "), x=expression(" ")) +
  geom_hline(aes(yintercept=mean(Means)), linetype="dashed") +
  #labs(y=expression(Blue~crab~per~set^{-1})) +
  expand_limits(x=c(1980,2020))
#T06TotalCPUE

E98FormTotal = subset(TotalCrab,
                     ProjID == "SCECAP Creek Trawl")
formula6 <- lm(E98FormTotal$CPUE ~ E98FormTotal$Year)
E98TotalCPUE = ggplot(aes(Year, log(CPUE)), data = subset(TotalCrab,
                                                          ProjID == "SCECAP Creek Trawl")) +
  ggtitle(" ") +
  #ggtitle("SCECAP Tidal Creek Trawl") +
  stat_summary(fun.data = "mean_se", size = .7) +
  #stat_poly_eq(aes(label = ..eq.label..), formula = formula6, parse = TRUE) +
  geom_smooth(method = 'loess', se=FALSE, color="black") +
  geom_hline(aes(yintercept=(log(mean(Means)))), linetype="dashed") +
  labs(y=expression(" "), x=expression(" ")) +
  #labs(y=expression((log)~Blue~crab~per~tow^{-1})) +
  expand_limits(x=c(1980,2020)) +
  coord_cartesian(ylim = c(0,8))

E99FormTotal = subset(TotalCrab,
                     ProjID == "SCECAP Harbor Trawl")
formula7 <- lm(E99FormTotal$CPUE ~ E99FormTotal$Year)
E99TotalCPUE = ggplot(aes(Year, CPUE), data = subset(TotalCrab,
                                                     ProjID == "SCECAP Harbor Trawl")) +
  ggtitle(" ") +
  #ggtitle("SCECAP Open Water Trawl") +
  stat_summary(fun.data = "mean_se", size = .7) +
  #stat_poly_eq(aes(label = ..eq.label..), formula = formula7, parse = TRUE) +
  geom_smooth(method = 'loess', se=FALSE, color="black") +
  geom_hline(aes(yintercept=mean(Means)), linetype="dashed") +
  labs(y=expression(" "), x=expression(" ")) +
  #labs(y=expression(Blue~crab~per~tow^{-1})) +
  expand_limits(x=c(1980,2020)) 

P88FormTotal = subset(TotalCrab,
                     ProjID == "Ashley Potting")
formula8<- lm(P88FormTotal$CPUE ~ P88FormTotal$Year)
P88FallTotalCPUE = TotalCrab %>%
  filter(ProjID == "Ashley Potting") %>%
  filter(Month %in% c("10", "11"))
P88FallTotalCPUE = ggplot(aes(Year, CPUE), data = subset(TotalCrab,
                                                         ProjID == "Ashley Potting")) +
  ggtitle(" ") +
  #ggtitle("Ashley River Potting Survey (fall)") +
  stat_summary(fun.data = "mean_se", size = .7) +
  #stat_poly_eq(aes(label = ..eq.label..), formula = formula8, parse = TRUE) +
  geom_smooth(method = 'loess', se=FALSE, color="black", na.rm = TRUE) +
  geom_hline(aes(yintercept=mean(Means)), linetype="dashed") +
  labs(y=expression(" "), x=expression(" ")) +
  #labs(y=expression(Blue~crab~per~soak^{-1})) +
  expand_limits(x=c(1980,2020))


##Only going to use this if we need a year-round look, but only goes to 2003
P88FormTotal2 = subset(TotalCrab,
                      ProjID == "Ashley Potting" &
                        Year > 2002)
formula9 <- lm(P88FormTotal$CPUE ~ P88FormTotal$Year)
P88TotalAnnualCPUE = ggplot(aes(Year, CPUE), data = subset(TotalCrab,
                                                           ProjID == "Ashley Potting" &
                                                             Year > 2002)) +
  ggtitle(" ") +
  #ggtitle("Ashley River Potting Survey (bi-monthly)") +
  stat_summary(fun.data = "mean_se", size = .7) +
  #stat_poly_eq(aes(label = ..eq.label..), formula = formula9, parse = TRUE) +
  geom_smooth(method = 'loess', se=FALSE, color="black", na.rm = TRUE) +
  geom_hline(aes(yintercept=mean(Means)), linetype="dashed") +
  labs(y=expression(" "), x=expression(" ")) +
  #labs(y=expression(Blue~crab~per~soak^{-1})) +
  expand_limits(x=c(1980,2020))
```

```{r Figure 2 (CRMS Survey Time Series), echo=FALSE, message=FALSE, warning=FALSE,dpi=600, fig.cap="Mean annual blue crab CPUE (mean ± standard error) for all SCDNR fisheries independent surveys, including Harbor Trawl (A), Creek Trawl (B), Ashley River Potting Survey (C), SCECAP Open Water Trawl (D), SCECAP Tidal Creek Trawl (E), and the Inshore Fisheries Trammel Net survey (F).   Dark line is loess smoothing trendline.  Broken line is survey mean.", fig.width=10,fig.height=11}

CRMSCPUETimeSeries <- plot_grid(B90TotalCPUE, T38TotalCPUE, P88FallTotalCPUE, 
                                E99TotalCPUE, E98TotalCPUE, T06TotalCPUE, ncol = 2, align = 'hv',
                                labels = c("A", "B", "C", "D", "E", "F"))
  
CRMSCPUETimeSeries 

```



